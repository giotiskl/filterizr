(function(global,$){"use strict";if(!$)throw new Error("Filterizr requires jQuery to work.");var Packer=function(w){this.init(w)};Packer.prototype={init:function(w){this.root={x:0,y:0,w:w}},fit:function(blocks){var n,node,block,len=blocks.length;var h=len>0?blocks[0].h:0;this.root.h=h;for(n=0;n<len;n++){block=blocks[n];if(node=this.findNode(this.root,block.w,block.h))block.fit=this.splitNode(node,block.w,block.h);else block.fit=this.growDown(block.w,block.h)}},findNode:function(root,w,h){if(root.used)return this.findNode(root.right,w,h)||this.findNode(root.down,w,h);else if(w<=root.w&&h<=root.h)return root;else return null},splitNode:function(node,w,h){node.used=true;node.down={x:node.x,y:node.y+h,w:node.w,h:node.h-h};node.right={x:node.x+w,y:node.y,w:node.w-w,h:h};return node},growDown:function(w,h){var node;this.root={used:true,x:0,y:0,w:this.root.w,h:this.root.h+h,down:{x:0,y:this.root.h,w:this.root.w,h:h},right:this.root};if(node=this.findNode(this.root,w,h))return this.splitNode(node,w,h);else return null}};$.fn.filterizr=function(){var self=this,args=arguments;if(!self._fltr){self._fltr=$.fn.filterizr.prototype.init(self,typeof args[0]==="object"?args[0]:undefined)}if(typeof args[0]==="string"){if(args[0].lastIndexOf("_")>-1)throw new Error("Filterizr error: You cannot call private methods");if(typeof self._fltr[args[0]]==="function"){self._fltr[args[0]](args[1],args[2])}else throw new Error("Filterizr error: There is no such function")}return self};$.fn.filterizr.prototype={init:function(container,options){var self=$(container).extend($.fn.filterizr.prototype);self.options={animationDuration:.5,callbacks:{onFilteringStart:function(){},onFilteringEnd:function(){},onShufflingStart:function(){},onShufflingEnd:function(){},onSortingStart:function(){},onSortingEnd:function(){}},delay:0,delayMode:"progressive",easing:"ease-out",filter:"all",filterOutCss:{opacity:0,transform:"scale(0.5)"},filterInCss:{opacity:1,transform:"scale(1)"},layout:"packed",setupControls:true};if(arguments.length===0){options=self.options}if(arguments.length===1&&typeof arguments[0]==="object")options=arguments[0];if(options){self.setOptions(options)}self.css({padding:0,position:"relative"});self._lastCategory=0;self._isAnimating=false;self._isShuffling=false;self._isSorting=false;self._mainArray=self._getFiltrItems();self._subArrays=self._makeSubarrays();self._activeArray=self._getCollectionByFilter(self.options.filter);self._toggledCategories={};self._toggledCategoriesGroup={};self._typedText=$("input[data-search]").val()||"";self._uID="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:r&3|8;return v.toString(16)});self._setupEvents();if(self.options.setupControls)self._setupControls();self.filter(self.options.filter);return self},filter:function(targetFilter){var self=this,target=self._getCollectionByFilter(targetFilter);var previous=self.options.filter;self.options.filter=targetFilter;self.trigger("filteringStart",[previous,targetFilter]);self._handleFiltering(target);if(self._isSearchActivated())self.search(self._typedText)},toggleFilter:function(toggledFilter){var self=this;var previous=Object.Assign({},self._toggledCategories);if(toggledFilter){if(toggledFilter==="all"){self._toggledCategories={}}else{if(!self._toggledCategories[toggledFilter])self._toggledCategories[toggledFilter]=true;else delete self._toggledCategories[toggledFilter]}}self.trigger("filteringStart",[previous,Object.Assign({},self._toggledCategories)]);if(self._multifilterModeOn()){self._handleFiltering(self._makeMultifilterArray())}else{self._handleFiltering(self._getCollectionByFilter("all"))}if(self._isSearchActivated())self.search(self._typedText)},groupFilter:function(toggledFilter,group){var self=this;var previous=JSON.parse(JSON.stringify(self._toggledCategoriesGroup));if(toggledFilter){if(group){if(toggledFilter==="all"){self._toggledCategoriesGroup[group]={}}else{if(!self._toggledCategoriesGroup[group][toggledFilter])self._toggledCategoriesGroup[group][toggledFilter]=true;else delete self._toggledCategoriesGroup[group][toggledFilter]}}else if(toggledFilter==="all"){self._toggledCategoriesGroup={}}else{throw new Error("Filterizr : calling groupFilter with a filter not equal to 'all' and without group is not permitted")}}self.trigger("filteringStart",[previous,JSON.parse(JSON.stringify(self._toggledCategoriesGroup))]);if(self._multifilterGroupModeOn()){self._handleFiltering(self._makeGroupMultifilterArray())}else{self._handleFiltering(self._getCollectionByFilter("all"))}if(self._isSearchActivated())self.search(self._typedText)},search:function(text){var self=this,array=self._multifilterGroupModeOn()?self._makeGroupMultifilterArray():self._multifilterModeOn()?self._makeMultifilterArray():self._getCollectionByFilter(self.options.filter),target=[],i=0;if(self._isSearchActivated()){for(i=0;i<array.length;i++){var containsText=array[i].text().toLowerCase().indexOf(text.toLowerCase())>-1;if(containsText){target.push(array[i])}}}if(target.length>0){self._handleFiltering(target)}else{if(self._isSearchActivated()){for(i=0;i<self._activeArray.length;i++){self._activeArray[i]._filterOut()}}else{self._handleFiltering(array)}}},shuffle:function(){var self=this;self._isAnimating=true;self._isShuffling=true;self.trigger("shufflingStart");self._mainArray=self._fisherYatesShuffle(self._mainArray);self._subArrays=self._makeSubarrays();var target=self._multifilterModeOn()?self._makeMultifilterArray():self._getCollectionByFilter(self.options.filter);if(self._isSearchActivated())self.search(self._typedText);else self._placeItems(target)},sort:function(attr,sortOrder){var self=this;attr=attr||"domIndex";sortOrder=sortOrder||"asc";self._isAnimating=true;self._isSorting=true;self.trigger("sortingStart");var isUserAttr=attr!=="domIndex"&&attr!=="sortData"&&attr!=="w"&&attr!=="h";if(isUserAttr){for(var i=0;i<self._mainArray.length;i++){self._mainArray[i][attr]=self._mainArray[i].data(attr)}}self._mainArray.sort(self._comparator(attr,sortOrder));self._subArrays=self._makeSubarrays();var target=self._multifilterModeOn()?self._makeMultifilterArray():self._getCollectionByFilter(self.options.filter);if(self._isSearchActivated())self.search(self._typedText);else self._placeItems(target)},setOptions:function(options){var self=this,i=0;for(var prop in options){self.options[prop]=options[prop]}if(self._mainArray&&(options.animationDuration||options.delay||options.easing||options.delayMode)){for(i=0;i<self._mainArray.length;i++){self._mainArray[i].css("transition","all "+self.options.animationDuration+"s "+self.options.easing+" "+self._mainArray[i]._calcDelay()+"ms")}}if(options.callbacks){if(!options.callbacks.onFilteringStart)self.options.callbacks.onFilteringStart=function(){};if(!options.callbacks.onFilteringEnd)self.options.callbacks.onFilteringEnd=function(){};if(!options.callbacks.onShufflingStart)self.options.callbacks.onShufflingStart=function(){};if(!options.callbacks.onShufflingEnd)self.options.callbacks.onShufflingEnd=function(){};if(!options.callbacks.onSortingStart)self.options.callbacks.onSortingStart=function(){};if(!options.callbacks.onSortingEnd)self.options.callbacks.onSortingEnd=function(){}}if(!self.options.filterInCss.transform)self.options.filterInCss.transform="translate3d(0,0,0)";if(!self.options.filterOutCss.transform)self.options.filterOutCss.transform="translate3d(0,0,0)"},_getFiltrItems:function(){var self=this,filtrItems=$(self.find(".filtr-item")),itemsArray=[];$.each(filtrItems,function(i,e){var item=$(e).extend(FiltrItemProto)._init(i,self);itemsArray.push(item)});return itemsArray},_makeSubarrays:function(){var self=this,subArrays=[];for(var i=0;i<self._lastCategory;i++)subArrays.push([]);for(i=0;i<self._mainArray.length;i++){var item=self._mainArray[i];if(Array.isArray(item._category)){for(var x=0;x<item._category.length;x++){var value;if(Array.isArray(item._category[x])){value=item._category[x][1]}else{value=item._category[x]}subArrays[value-1].push(item)}}else subArrays[self._mainArray[i]._category-1].push(self._mainArray[i])}return subArrays},_makeMultifilterArray:function(){var self=this,target=[],addedMap={};for(var i=0;i<self._mainArray.length;i++){var item=self._mainArray[i],belongsToCategory=false,isUnique=item.domIndex in addedMap===false;if(Array.isArray(item._category)){for(var x=0;x<item._category.length;x++){var value;if(Array.isArray(item._category[x])){value=item._category[x][1]}else{value=item._category[x]}if(value in self._toggledCategories){belongsToCategory=true;break}}}else{if(item._category in self._toggledCategories)belongsToCategory=true}if(isUnique&&belongsToCategory){addedMap[item.domIndex]=true;target.push(item)}}return target},_makeGroupMultifilterArray:function(){var self=this,target=[],addedMap={};for(var i=0;i<self._mainArray.length;i++){var item=self._mainArray[i],isUnique=item.domIndex in addedMap===false;if(isUnique&&Object.keys(self._toggledCategoriesGroup).every(function(group){if(Array.isArray(item._category)){return Object.keys(self._toggledCategoriesGroup[group]).length===0||item._category.some(self._checkCategory(group))}else{return Object.keys(self._toggledCategoriesGroup[group]).length===0||self._checkCategory(group)(item._category)}})){addedMap[item.domIndex]=true;target.push(item)}}return target},_checkCategory:function(group){var self=this;return function(category){if(Array.isArray(category)){return category[0]===group&&category[1]in self._toggledCategoriesGroup[group]}else{return category in self._toggledCategoriesGroup[group]}}},_setupControls:function(){var self=this;$("*[data-filter]").click(function(){var targetFilter=$(this).data("filter");if(self.options.filter===targetFilter)return;self.filter(targetFilter)});$("*[data-multifilter]").click(function(){var targetFilter=$(this).data("multifilter");self.toggleFilter(targetFilter)});$("*[data-groupmultifilter]").click(function(){var info=$(this).data("groupmultifilter").split("-");var targetFilter=info[1];var group=info[0];if(group&&targetFilter){if(!self._toggledCategoriesGroup[group]){self._toggledCategoriesGroup[group]={}}self.groupFilter(targetFilter,group)}else if(group==="all"){self.groupFilter(group)}else{console.log("groupmultifilter must have data of format {groupName-categoriesNumber/all} or only all")}});$("*[data-shuffle]").click(function(){self.shuffle()});$("*[data-sortAsc]").click(function(){var sortAttr=$("*[data-sortOrder]").val();self.sort(sortAttr,"asc")});$("*[data-sortDesc]").click(function(){var sortAttr=$("*[data-sortOrder]").val();self.sort(sortAttr,"desc")});$("input[data-search]").keyup(function(){self._typedText=$(this).val();self._delayEvent(function(){self.search(self._typedText)},250,self._uID)})},_setupEvents:function(){var self=this;$(global).resize(function(){self._delayEvent(function(){self.trigger("resizeFiltrContainer")},250,self._uID)});self.on("resizeFiltrContainer",function(){if(self._multifilterGroupModeOn())self.groupFilter();else if(self._multifilterModeOn())self.toggleFilter();else self.filter(self.options.filter)}).on("filteringStart",function(event,previousData,nextData){self.options.callbacks.onFilteringStart(previousData,nextData)}).on("filteringEnd",function(event,newData){self.options.callbacks.onFilteringEnd(newData)}).on("shufflingStart",function(){self._isShuffling=true;self.options.callbacks.onShufflingStart()}).on("shufflingEnd",function(){self.options.callbacks.onShufflingEnd();self._isShuffling=false}).on("sortingStart",function(){self._isSorting=true;self.options.callbacks.onSortingStart()}).on("sortingEnd",function(){self.options.callbacks.onSortingEnd();self._isSorting=false})},_calcItemPositions:function(){var self=this,array=self._activeArray,containerHeight=0,cols=Math.round(self.width()/self.find(".filtr-item").outerWidth()),rows=0,itemWidth=self.find(".filtr-item").outerWidth(),itemHeight=0,left=0,top=0,i=0,x=0,posArray=[];if(self.options.layout==="packed"){$.each(self._activeArray,function(i,e){e._updateDimensions()});var packer=new Packer(self.outerWidth());packer.fit(self._activeArray);for(i=0;i<array.length;i++){posArray.push({left:array[i].fit.x,top:array[i].fit.y})}containerHeight=packer.root.h}if(self.options.layout==="horizontal"){rows=1;for(i=1;i<=array.length;i++){itemWidth=array[i-1].outerWidth();itemHeight=array[i-1].outerHeight();posArray.push({left:left,top:top});left+=itemWidth;if(containerHeight<itemHeight)containerHeight=itemHeight}}else if(self.options.layout==="vertical"){for(i=1;i<=array.length;i++){itemHeight=array[i-1].outerHeight();posArray.push({left:left,top:top});top+=itemHeight}containerHeight=top}else if(self.options.layout==="sameHeight"){rows=1;var rowWidth=self.outerWidth();for(i=1;i<=array.length;i++){itemWidth=array[i-1].width();var itemOuterWidth=array[i-1].outerWidth(),nextItemWidth=0;if(array[i])nextItemWidth=array[i].width();posArray.push({left:left,top:top});x=left+itemWidth+nextItemWidth;if(x>rowWidth){x=0;left=0;top+=array[0].outerHeight();rows++}else left+=itemOuterWidth}containerHeight=rows*array[0].outerHeight()}else if(self.options.layout==="sameWidth"){for(i=1;i<=array.length;i++){posArray.push({left:left,top:top});if(i%cols===0)rows++;left+=itemWidth;top=0;if(rows>0){x=rows;while(x>0){top+=array[i-cols*x].outerHeight();x--}}if(i%cols===0)left=0}for(i=0;i<cols;i++){var columnHeight=0,index=i;while(array[index]){columnHeight+=array[index].outerHeight();index+=cols}if(columnHeight>containerHeight){containerHeight=columnHeight;columnHeight=0}else columnHeight=0}}else if(self.options.layout==="sameSize"){for(i=1;i<=array.length;i++){posArray.push({left:left,top:top});left+=itemWidth;if(i%cols===0){top+=array[0].outerHeight();left=0}}rows=Math.ceil(array.length/cols);containerHeight=rows*array[0].outerHeight()}self.css("height",containerHeight);return posArray},_handleFiltering:function(target){if(!target){var target=0}var self=this,toFilterOut=self._getArrayOfUniqueItems(self._activeArray,target);for(var i=0;i<toFilterOut.length;i++){toFilterOut[i]._filterOut()}self._activeArray=target;self._placeItems(target)},_multifilterModeOn:function(){var self=this;return Object.keys(self._toggledCategories).length>0},_multifilterGroupModeOn:function(){var self=this;return Object.keys(self._toggledCategoriesGroup).some(function(group){return Object.keys(self._toggledCategoriesGroup[group]).length>0})},_isSearchActivated:function(){var self=this;return self._typedText.length>0},_placeItems:function(arr){var self=this;self._isAnimating=true;self._itemPositions=self._calcItemPositions();for(var i=0;i<arr.length;i++){arr[i]._filterIn(self._itemPositions[i])}},_getCollectionByFilter:function(filter){var self=this;return filter==="all"?self._mainArray:self._subArrays[filter-1]},_makeDeepCopy:function(obj){var r={};for(var p in obj)r[p]=obj[p];return r},_comparator:function(prop,sortOrder){return function(a,b){if(sortOrder==="asc"){if(a[prop]<b[prop])return-1;else if(a[prop]>b[prop])return 1;else return 0}else if(sortOrder==="desc"){if(b[prop]<a[prop])return-1;else if(b[prop]>a[prop])return 1;else return 0}}},_getArrayOfUniqueItems:function(arr1,arr2){var r=[],o={},l=arr2.length,i,v;for(i=0;i<l;i++){o[arr2[i].domIndex]=true}l=arr1.length;for(i=0;i<l;i++){v=arr1[i];if(!(v.domIndex in o)){r.push(v)}}return r},_delayEvent:function(){var self=this,timers={};return function(callback,ms,uniqueId){if(uniqueId===null){throw Error("UniqueID needed")}if(timers[uniqueId]){clearTimeout(timers[uniqueId])}timers[uniqueId]=setTimeout(callback,ms)}}(),_fisherYatesShuffle:function shuffle(array){var m=array.length,t,i;while(m){i=Math.floor(Math.random()*m--);t=array[m];array[m]=array[i];array[i]=t}return array}};var FiltrItemProto={_init:function(index,parent){var self=this,delay=0;self._parent=parent;self._category=self._getCategory();self._lastPos={};self.domIndex=index;self.sortData=self.data("sort");self.w=0;self.h=0;self._isFilteredOut=true;self._filteringOut=false;self._filteringIn=false;self.css(parent.options.filterOutCss).css({"-webkit-backface-visibility":"hidden",perspective:"1000px","-webkit-perspective":"1000px","-webkit-transform-style":"preserve-3d",position:"absolute",transition:"all "+parent.options.animationDuration+"s "+parent.options.easing+" "+self._calcDelay()+"ms"});self.on("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",function(){self._onTransitionEnd()});return self},_updateDimensions:function(){var self=this;self.w=self.outerWidth();self.h=self.outerHeight()},_calcDelay:function(){var self=this,r=0;if(self._parent.options.delayMode==="progressive")r=self._parent.options.delay*self.domIndex;else if(self.domIndex%2===0)r=self._parent.options.delay;return r},_getCategory:function(){var self=this,ret=self.data("category");if(typeof ret==="string"){ret=ret.split(/\s*,\s*/);for(var i=0;i<ret.length;i++){var tab=ret[i].split("-");var value;if(tab.length<=1){value=parseInt(ret[i])}else if(tab.length===2){ret[i]=tab;value=parseInt(ret[i][1])}else{throw new Error("Filteriz: the value of data-category must not have more than one dash")}if(isNaN(value)){throw new Error("Filterizr: the value of data-category must be a number, starting from value 1 and increasing.")}if(value>self._parent._lastCategory){self._parent._lastCategory=value}}}else{if(ret>self._parent._lastCategory)self._parent._lastCategory=ret}return ret},_onTransitionEnd:function(){var self=this;if(self._filteringOut){$(self).addClass("filteredOut");self._isFilteredOut=true;self._filteringOut=false}else if(self._filteringIn){self._isFilteredOut=false;self._filteringIn=false}if(self._parent._isAnimating){if(self._parent._isShuffling)self._parent.trigger("shufflingEnd");else if(self._parent._isSorting)self._parent.trigger("sortingEnd");else{var argData;if(self._parent._multifilterGroupModeOn()){argData=JSON.parse(JSON.stringify(self._parent._toggledCategoriesGroup))}else if(self._parent._multifilterModeOn()){argData=Object.Assign({},self._parent._toggledCategories)}else{argData=self._parent.options.filter}self._parent.trigger("filteringEnd",[argData])}self._parent._isAnimating=false}},_filterOut:function(){var self=this,filterOutCss=self._parent._makeDeepCopy(self._parent.options.filterOutCss);filterOutCss.transform+=" translate3d("+self._lastPos.left+"px,"+self._lastPos.top+"px, 0)";self.css(filterOutCss);self.css("pointer-events","none");self._filteringOut=true},_filterIn:function(targetPos){var self=this,filterInCss=self._parent._makeDeepCopy(self._parent.options.filterInCss);$(self).removeClass("filteredOut");self._filteringIn=true;self._lastPos=targetPos;self.css("pointer-events","auto");filterInCss.transform+=" translate3d("+targetPos.left+"px,"+targetPos.top+"px, 0)";self.css(filterInCss)}}})(this,jQuery);